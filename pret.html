<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="viewport" content="user-scalable=no, width=device-width, initial-scale=0.5, maximum-scale=0.5,minimum-scale=0.5, target-densitydpi=medium-dpi" />
    <title></title>
    <link rel="stylesheet" href="css/fonts/PTSans/stylesheet.css" type="text/css">
    <link rel="stylesheet" href="css/jqmobile/jquery.mobile-1.4.4.min.css" />
    <script src="js/jq.min.js"></script>
    <script src="js/jquery.mobile-1.4.4.min.js"></script>
    <script type="text/javascript" src="js/highcharts.js"></script>
    <script type="text/javascript" src="js/hc-theme.js"></script>
    <script type="text/javascript" src="js/my_common_scripts.js"></script>
    <script type="text/javascript" src="js/fastclick.js"></script>
    <script type="text/javascript" src="js/moment.js"></script>
    <script type="text/javascript" src="js/menu.js"></script>

    <link rel="stylesheet" type="text/css" href="css/filters.css">
    <link rel="stylesheet" type="text/css" href="css/common.css">

    <!--empl css-->
    <link rel="stylesheet" type="text/css" href="css/empl.css">

    <script type="text/javascript" src="js/empl.js"></script>
    <script type="text/javascript" src="js/data/empl.js"></script>

    <!--objects -->

    <link rel="stylesheet" type="text/css" href="css/objects.css">
    <link rel="stylesheet" type="text/css" href="css/object_view.css">

    <script src="http://api-maps.yandex.ru/2.0.18/?load=package.standard,package.clusters&lang=ru-RU" type="text/javascript"></script>
    <script type="text/javascript" src="js/data/objects.js"></script>
    <script type="text/javascript" src="js/objects/filter.js"></script>
    <script type="text/javascript" src="js/objects/charts.js"></script>
    <script type="text/javascript" src="js/objects/map_marker.js"></script>
    <script type="text/javascript" src="js/objects/objects_logic.js"></script>

    <script type="text/javascript" src="js/objects/obj_view.js"></script>


    <!--oranizations-->
    <link rel="stylesheet" type="text/css" href="css/organization.css">

    <script type="text/javascript" src="js/data/organizations.js"></script>
    <script type="text/javascript" src="js/organizations_logic.js"></script>


    <!--tenders-->
    <link rel="stylesheet" type="text/css" href="css/tenders.css">

    <script type="text/javascript" src="js/tenders.js"></script>
    <script type="text/javascript" src="js/data/tenders.js"></script>


    <!--sales-->
    <link rel="stylesheet" type="text/css" href="css/sales.css">

    <script type="text/javascript" src="js/highcharts-more.js"></script>
    <script type="text/javascript" src="js/sales.js"></script>
    <script type="text/javascript" src="js/my_common_scripts.js"></script>
    <script type="text/javascript" src="js/data/sales.js"></script>
    <script type="text/javascript" src="js/data/claims.js"></script>

</head>
<body >
<div class="status-bar"></div>
<div id="left-menu">
    <a href="empl.html" data-transition="slide">
        <div id='logo' class="menu-picture"></div>
    </a>
    <div id="float_background"></div>
    <hr class="menu-item-devider">
    <div class="menu">
        <a href="empl.html" data-transition="slide" data-prefetch>
            <div class="menu-item menu-item-active">
                <div class="menu-picture empl-menu-picture "></div>
                <div class="menu-item-text">Кадры</div>
            </div>
        </a>
        <hr class="menu-item-devider">
        <a href="objects.html" data-transition="slide" data-prefetch>
            <div class="menu-item">
                <div class="menu-picture obj-menu-picture"></div>
                <div class="menu-item-text">Объекты</div>
            </div>
        </a>
        <hr class="menu-item-devider">
        <a href="organizations.html" data-transition="slide" data-prefetch>
            <div class="menu-item">
                <div class="menu-picture contractors-menu-picture "></div>
                <div class="menu-item-text">Подрядчики</div>
            </div>
        </a>
        <hr class="menu-item-devider">
        <a href="tenders.html" data-transition="slide" data-prefetch>
            <div class="menu-item ">
                <div class="menu-picture tenders-menu-picture "></div>
                <div class="menu-item-text">Конкурсы</div>
            </div>
        </a>
        <hr class="menu-item-devider">
        <a href="sales.html" data-transition="slide" data-prefetch>
            <div class="menu-item">
                <div class="menu-picture sales-menu-picture "></div>
                <div class="menu-item-text">Продажи</div>
            </div>
        </a>
    </div>
</div>
<div class="right-side" data-role="page" id='claim'>
    <!--<div data-role="header" data-position="fixed">-->
    <div class="header">
        <div class="header-paginator"></div>
        <div class="header-title header-item">
            Претензии
        </div>
    </div>
    <div data-role="content " style="padding: 15px; margin-left: 180px;">

        <div class='claim-tabs tabs' id="claim_tabs">
            <form>
                <!--<div class="empl-tabs-group-name"></div>-->
                <fieldset data-role="controlgroup" data-type="horizontal" id="claim-charts-tabs" class="tabs tabs-active">
                    <input type="radio" name="cliam-chart" id="claim_c1" data-div="summary" checked="checked">
                    <label for="claim_c1">Сводка по статусам</label>
                    <input type="radio" name="cliam-chart" id="claim_c2" data-div="dynamics" >
                    <label for="claim_c2">Динамика</label>
                    <input type="radio" name="cliam-chart" id="claim_c3" data-div="payment" >
                    <label for="claim_c3">Получение выплат</label>
                    <input type="radio" name="cliam-chart" id="claim_c4" data-div="court" >
                    <label for="claim_c4">Суд</label>
                    <input type="radio" name="cliam-chart" id="claim_c5" data-div="contragent" >
                    <label for="claim_c5">Подрядчики</label>
                    <input type="radio" name="cliam-chart" id="claim_c6" data-div="koef_chart" >
                    <label for="claim_c6">Список</label>
                </fieldset>

                <fieldset data-role="controlgroup" data-type="horizontal" id="claim-measure-tabs" class="tabs tabs-active">
                    <input type="radio" name="claim-measure" id="summ" checked="checked">
                    <label for="summ">Сумма</label>
                    <input type="radio" name="claim-measure" id="count" >
                    <label for="count">Количество</label>
                </fieldset>
            </form>
        </div>

        <div id="claim-charts-content" style="margin-top: 50px">
            <div>
                <div id="summary" class="claim-tab" style="display:none">
                    <div class="claim_chart" id="summary_chart" style="height: 1200px; width: 1800px; float: left"></div>
                </div>
                <div id="dynamics" class="claim-tab" style="display:none">
                    <div class="claim_chart" id="dynamics_chart" style="height: 1200px; width: 1800px; float: left;"></div>
                </div>
                <div id="payment" class="claim-tab" style="display:none">
                    <div class="claim_chart" id="payment_chart" style="height: 1200px; width: 1800px; float: left;"></div>
                </div>
                <div id="court" class="claim-tab" style="display:none">
                    <div class="claim_chart" id="court_chart" style="height: 1200px; width: 900px; float: left;"></div>
                    <div class="claim_chart" id="court_desicion_chart" style="height: 1200px; width: 900px; float: left;"></div>
                </div>
                <div id="contragent" class="claim-tab" style="display:none">
                    <div class="claim_chart" id="contragent_chart" style="height: 1200px; width: 1800px; float: left;"></div>
                </div>

                <!--<div id="empl_department_chart" class="empl_chart" style="height: 1100px; width: 1800px; float: left; display: none;"></div>-->
                <!--<div id="personal_chart" class="empl_chart" style="height: 1100px; width: 1800px; float: left; display: none;"></div>-->
                <!--<div id="koef_chart" class="empl_chart" style="height: 1100px; width: 1800px; float: left; display: none;"></div>-->
                <!--<div id="aup_salary_structure_chart" class="empl_chart" style="height: 1100px; width: 1800px; float: left; display: none;"></div>-->
                <!--<div id="attitude_chart" class="empl_chart" style="height: 1100px; width: 1800px; float: left; display: none;"></div>-->
            </div>
        </div>
    </div>
</div>
</body>



<script type="text/javascript">
    var kpApp ={};
    kpApp.claims = {
        current_tab: null,
        claims: claims,
        initClaims: function(){
            $('#claim-charts-tabs input').change(kpApp.claims.changeTab);
            kpApp.claims.changeTab();
            $('#claim-measure-tabs input').change(function(){
                kpApp.claims.current_tab.redrawChart();
            });
        },
        changeTab: function (){
            $('.claim-tab').hide();
            $('#'+$('#claim-charts-tabs input:checked').attr('data-div')).show();
            kpApp.claims.current_tab =  kpApp.claims.tabs[$('#claim-charts-tabs input:checked').attr('data-div')]
            kpApp.claims.current_tab.fill();
        },
        getCurrentMeasure: function(){
            return  $('#claim-measure-tabs input:checked').attr('id')
        }
    }

    kpApp.claims.tabs={
         summary:{
            chart: null,
             data: null,
            fill:function(){
                this.data = this.getData();
                this.createChart();
            },
            getData: function(){
                var currentDate = moment();
                var res = {
                    'init': {count:0,summ:0},
                    'end': {count:0,summ:0},
                    'in_court': {count:0,summ:0},
                    'court_decision': {count:0,summ:0}
                }
                $.each(kpApp.claims.claims, function(i, c){
                    if (moment(c.date_init).year()!=currentDate.year()) return;
                    res.init.count++;
                    res.init.summ+= c.summ;
                    if(c.date_compensation_get && moment(c.date_compensation_get).isBefore(currentDate)){
                        res.end.count++;
                        res.end.summ+= c.summ;
                    }
                    if(c.date_go_to_court && moment(c.date_go_to_court).isBefore(currentDate) &&
                            (c.date_court_decision==null || (c.date_court_decision && moment(c.date_court_decision).isBefore(currentDate)))){
                        res.in_court.count++;
                        res.in_court.summ+= c.summ;
                    }
                    if(c.date_court_decision && moment(c.date_court_decision).isBefore(currentDate)){
                        res.court_decision.count++;
                        res.court_decision.summ+= c.summ;
                    }

                })
                return res;
            },
            createChart: function(){
                this.chart = new Highcharts.Chart({
                    chart: {
                        type: 'bar',
                        renderTo: 'summary_chart'
                    },
                    title: {
                        text: 'Текущее состояние претензий (с переключением по сумме)'
                    },
                    xAxis: {
                        categories: ['2015 год']
                    },
                    yAxis: {
                        min: 0,
                        title: {
                            text: 'количество'
                        }
                    },
                    legend: {
                        reversed: true
                    },
                    tooltip: {
                        formatter: function () {
                            return '<b>' + this.x + '</b><br/>' +
                                    this.series.name + ': ' +(this.y) + '<br/>'

                        }
                    },
                    plotOptions: {
                        series: {
                            //stacking: 'percent'
                        }
                    },
                    series: [ {
                        name: 'Положительное решение суда но не оплачено ',
                        data: [10]
                    }, {
                        name: 'На рассмотрении в суде',
                        data: [0]
                    },{
                        name: 'Компенсация получена',
                        data: [0]
                    }, {
                        name: 'Претензий предъявлено',
                        data: [0]
                    }]
                });
                this.redrawChart();
            },
            redrawChart: function(){
                var currentMeasure = kpApp.claims.getCurrentMeasure();
                this.chart.series[0].setData([this.data.court_decision[currentMeasure]],false)
                this.chart.series[1].setData([this.data.in_court[currentMeasure]],false)
                this.chart.series[2].setData([this.data['end'][currentMeasure]],false)
                this.chart.series[3].setData([this.data['init'][currentMeasure]])
            }
         },
         dynamics:{
            chart: null,
            data: null,
            fill:function(){
                this.createChart();
            },
            getData: function(){
                var res  = {
                    request : {
                        count: [0,0,0,0,0,0,0,0,0,0,0,0],
                        summ: [0,0,0,0,0,0,0,0,0,0,0,0]
                    },
                    gets: {
                        count: [0,0,0,0,0,0,0,0,0,0,0,0],
                        summ: [0,0,0,0,0,0,0,0,0,0,0,0]
                    }
                }
                $.each(claims, function(i,c){
                    if(c.date_init){
                        res.request.count[moment(c.date_init).month()]++;
                        res.request.summ[moment(c.date_init).month()] += c.summ;
                    }
                    if (c.date_compensation_get){
                        res.gets.count[moment(c.date_compensation_get).month()]++;
                        res.gets.summ[moment(c.date_compensation_get).month()] += c.summ;
                    }
                })
                for (var i = 1; i<12; i++){
                    res.request.count[i]+=res.request.count[i-1]
                    res.request.summ[i]+=res.request.summ[i-1]
                    res.gets.count[i]+=res.gets.count[i-1]
                    res.gets.summ[i]+=res.gets.summ[i-1]
                }
                return res;
            },
            createChart:function(){
                this.chart =  new Highcharts.Chart({
                    chart: {
                        type: 'area',
                        renderTo: 'dynamics_chart'
                    },
                    title: {
                        text: 'Динамика удовлетворение претензий (с переключение по количеству)'
                    },
                    xAxis: {
                        categories: ['Янв', 'Фев', 'Март', 'Апр', 'Май', 'Июнь', 'Июль', 'Авг', 'Сен', 'Окт', 'Ноя', 'Дек'],
                        allowDecimals: false,
                        labels: {
                            formatter: function () {
                                return this.value; // clean, unformatted number for year
                            }
                        }
                    },
                    yAxis: {
                        title: {
                            text: 'Сумма'
                        },
                        labels: {
                            formatter: function () {
                                return this.value / 1000000 + ' млн';
                            }
                        }
                    },
                    plotOptions: {
                        area: {
                            marker: {
                                enabled: false,
                                symbol: 'circle',
                                radius: 2,
                                states: {
                                    hover: {
                                        enabled: true
                                    }
                                }
                            }
                        }
                    },
                    series: [{
                        name: 'Предъявлено',
                        data: [0]
                    }, {
                        name: 'Удовлетворено',
                        data: [0]
                    }]
                });
                this.redrawChart();
            },
            redrawChart: function(){
                this.data = this.getData();
                var currentMeasure = kpApp.claims.getCurrentMeasure();
                this.chart.series[0].setData(this.data.request[currentMeasure], false)
                this.chart.series[1].setData(this.data.gets[currentMeasure])

            }
         },
         payment:{
             chart: null,
             data: null,
            fill: function(){
                this.data = this.getData();

                this.createChart();
            },
            getData: function(){
                var xaxis = [];
                var data = {};
                $.each(kpApp.claims.claims, function(i,c){
                    var year = moment(c.date_init).year()+'';
                    if (xaxis.indexOf(year)<0) xaxis.push(year);
                    if (!data[year]) data[year] = {voluntarily: {summ: 0, count:0}, in_court: {summ:0, count:0}}
                    if (c.is_voluntarily) {
                        data[year].voluntarily.summ += c.summ;
                        data[year].voluntarily.count++;
                    }
                    else {
                        data[year].in_court.summ += c.summ;
                        data[year].in_court.count++;
                    }
                })

                var voluntarily = {summ: [], count: []}
                var in_court = {summ: [], count: []}
                $.each(data, function(year, val){

                    voluntarily.summ.push(val.voluntarily.summ)
                    voluntarily.count.push(val.voluntarily.count)
                    in_court.summ.push(val.voluntarily.summ)
                    in_court.count.push(val.voluntarily.count)
                })
                return {
                    xaxis: xaxis,
                    data: {
                        voluntarily: voluntarily,
                        in_court: in_court
                    }
                }
            },
            createChart: function(){
                var x = this.data.xaxis;
                this.chart = new Highcharts.Chart({
                    chart: {
                        type: 'column',
                        renderTo: 'payment_chart'
                    },
                    title: {
                        text: 'Получение выплат по искам'
                    },
                    xAxis: {
                        categories:  x
                    },
                    yAxis: {
                        min: 0,
                        title: {
                            text: 'Сумма исков'
                        },
                        stackLabels: {
                            enabled: true,
                            formatter: function (){return million_to_text(this.total)},
                            style: {
                                color: (Highcharts.theme && Highcharts.theme.textColor) || 'gray',
                                font: '30px PT Sans, sans-serif',
                                'font-size': '30px'
                            }
                        }
                    },
                    tooltip: {
                        formatter: function () {
                            return '<b>' + this.x + '</b><br/>' +
                                    this.series.name + ': ' + million_to_text(this.y) + '<br/>' +
                                    'Всего: ' + million_to_text(this.point.stackTotal);
                        }
                    },
                    plotOptions: {
                        column: {
                            stacking: 'normal',
                            dataLabels: {
                                enabled: false,
                                color: (Highcharts.theme && Highcharts.theme.dataLabelsColor) || 'white',
                                style: {
                                    textShadow: '0 0 3px black',
                                    fontSize: "20px"
                                }
                            }
                        }
                    },
                    series: [{
                        name: 'Оплачено добровольно',
                        data: [0]
                    }, {
                        name: 'Опалчено по решению суда',
                        data: [0]
                    }]
                });
                this.redrawChart();
            },
            redrawChart: function(){
                var currentMeasure = kpApp.claims.getCurrentMeasure();
                this.chart.series[0].setData(this.data.data.voluntarily[currentMeasure],false)
                this.chart.series[1].setData(this.data.data.in_court[currentMeasure],true)
            }
        },
         court: {
             chart1: null,
             chart2: null,
             data: null,
             fill: function(){

                 this.createChart();
             },
             getData: function(){
                 var voluntarily = {
                     summ: [["Добровольно",0], ['По решению суда', 0]],
                     count: [["Добровольно",0], ['По решению суда', 0]]
                 }
                 var court_decision = {
                     summ: [["Положительное",0], ["Отрицательное",0]],
                     count: [["Положительное",0], ["Отрицательное",0]]
                 }
                 var currentDate = moment();
                 $.each(kpApp.claims.claims, function(i,c){
                     if (moment(c.date_init).year()!=currentDate.year()) return;
                     if (!c.date_compensation_get) return;
                     if (c.is_voluntarily){
                         voluntarily.summ[0][1]+= c.summ;
                         voluntarily.count[0][1]++;
                     }
                     else{
                         voluntarily.summ[1][1]+= c.summ;
                         voluntarily.count[1][1]++;
                     }
                     if (!c.date_go_to_court) return;
                     console.log('court')
                     if (c.court_decision!='отриц'){
                         court_decision.summ[0][1]+= c.summ;
                         court_decision.count[0][1]++;
                     }
                     else{
                         court_decision.summ[1][1]+= c.summ;
                         court_decision.count[1][1]++;
                     }
                 })
                 return {
                     voluntarily: voluntarily,
                     court_decision: court_decision
                 }
             },
             createChart: function(){
                 this.chart1 = new Highcharts.Chart({
                     chart: {
                         plotBackgroundColor: null,
                         plotBorderWidth: 0,//null,
                         plotShadow: false,
                         renderTo:'court_chart'
                     },
                     title: {
                         text: 'Решение претензий в добровольном порядке (с переключением по сумме)'
                     },
                     tooltip: {
                         enabled: false,
                         pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                     },
                     plotOptions: {
                         pie: {
                             allowPointSelect: false,
                             cursor: 'pointer',
                             dataLabels: {
                                 enabled: true
                             },
                             showInLegend: true
                         }
                     },
                     series: [{
                         type: 'pie',
                         name: 'Browser share',
                         data: [ ],
                         size: '60%',
                         dataLabels: {
                             formatter: function () {
                                 return this.percentage > 5 ? this.point.percentage.toFixed(0)+'%' : null;
                             },
                             color: 'white',
                             distance: -60 ,
                             style: {
                                 color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black',
                                 fontSize: "20px"
                             }
                         }
                     }]
                 });
                 this.chart2 = new Highcharts.Chart({
                     chart: {
                         plotBackgroundColor: null,
                         plotBorderWidth: null,
                         plotShadow: false,
                         renderTo: 'court_desicion_chart'
                     },
                     title: {
                         text: 'Доля положительного решения суда (с переключением по сумме)'
                     },
                     tooltip: {
                         enabled: false,
                         pointFormat: '{series.name}: <b>{point.percentage:.1f}%</b>'
                     },
                     plotOptions: {
                         pie: {
                             allowPointSelect: false,
                             cursor: 'pointer',
                             dataLabels: {
                                 enabled: true
                             },
                             showInLegend: true
                         }
                     },
                     series: [{
                         type: 'pie',
                         name: 'Browser share',
                         size: '60%',
                         data: [] ,
                         dataLabels: {
                             formatter: function () {
                                 return this.percentage > 5 ? this.point.percentage.toFixed(0)+'%' : null;
                             },
                             color: 'white',
                             distance: -60 ,
                             style: {
                                 color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black',
                                 fontSize: "20px"
                             }
                         }
                     }]
                 });
                 this.redrawChart();
             },
             redrawChart: function(){
                 this.data= this.getData();
                 var currentMeasure = kpApp.claims.getCurrentMeasure();
                 this.chart1.series[0].setData(this.data.voluntarily[currentMeasure])
                 this.chart2.series[0].setData(this.data.court_decision[currentMeasure])
             }
         },
         contragent: {
             chart: null,
             data: null,
             fill: function(){

                 this.createChart();
             },
             getData: function(){
                 var by_summ = {};
                 var by_count = {};

                 $.each(kpApp.claims.claims, function(i, c){
                     if (!by_summ[c.contragent])  by_summ[c.contragent] = 0
                     if (!by_count[c.contragent])  by_count[c.contragent] = 0
                     by_count[c.contragent]++;
                     by_summ[c.contragent]+= c.summ;
                 })

                 var res = {
                     summ: [],
                     count: []
                 }
                 $.each(by_summ, function (comp, summ){
                     res.summ.push([comp, summ]);
                 });
                 $.each(by_count, function (comp, count){
                     res.count.push([comp, count]);
                 });
                 function sortFunction(a, b){
                     if(a[1]<b[1])
                     return 1
                     if(a[1]>b[1])
                     return -1
                     return 0
                 }

                 res.summ.sort(sortFunction)
                 res.count.sort(sortFunction)
                 for (var i = res.summ.length-1; i>3; i --){
                     res.summ[i-1][1]+=res.summ[i][1];
                     res.summ.length = i;
                     res.count[i-1][1]+=res.count[i][1];
                     res.count.length = i;
                 }
                 res.summ[3][0] = 'Остальные';
                 res.count[3][0] = 'Остальные';
                 return res;
             },
             createChart: function(){
                 this.chart = new Highcharts.Chart({
                     chart: {
                         type: 'pie',
                         renderTo: 'contragent_chart'
                     },
                     title: {
                         text: 'Распределение числа претензий по подрядчикам (с переключением по сумме)'
                     },
                     yAxis: {
                         title: {
                             text: 'Total percent market share'
                         }
                     },
                     plotOptions: {
                         pie: {
                             shadow: false,
                             center: ['50%', '50%']
                         }
                     },
                     tooltip: {
                         enabled: false,
                         valueSuffix: '%'
                     },
                     series: [ {
                         name: 'Претензий на подрядчика',
                         data: [

                           ],
                         size: '80%',
                         innerSize: '60%',
                         dataLabels: {
                             formatter: function () {
                                 // display only if larger than 1
                                 return this.percentage > 3 ? '<b>' + this.point.name + ':</b> ' + this.percentage.toFixed() + '%'  : null;
                             },
                             style: {
                                 color: (Highcharts.theme && Highcharts.theme.contrastTextColor) || 'black',
                                 fontSize: "20px"
                             }
                         }
                     }]
                 });
                 this.redrawChart();
             },
             redrawChart: function(){
                 this.data = this.getData();
                 console.log(this.data)
                 this.chart.series[0].setData(this.data[kpApp.claims.getCurrentMeasure()])
             }
         }
    }
    $(function(){
        kpApp.claims.initClaims();
    })


</script>
</html>